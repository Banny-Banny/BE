# Feature: 결제 완료 시 타임캡슐 자동 생성

## 개요
- 결제까지 완료된 주문(PAID)이 확정되면 해당 주문의 옵션/인원 설정을 반영한 타임캡슐을 자동으로 생성한다.
- 주문 시 선택한 상품 제약(미디어 타입/최대 개수, 상품 활성화 여부)과 인원 수(headcount)를 캡슐 생성 시점에 검증/반영한다.

## 목표
- 성공적으로 결제된 주문은 1회 자동으로 타임캡슐이 생성되고, 생성된 캡슐 ID가 클라이언트에 제공된다.
- 생성된 캡슐의 열람 시점(openAt), 열람 가능 인원(viewLimit), 미디어 제약이 주문 옵션·상품 제약과 일치한다.
- 중복 생성·잘못된 상품/인원/옵션으로 인한 데이터 불일치를 방지한다.

## 비범위
- 캡슐 편집/미디어 업로드 UI 변경 자체는 포함하지 않음(생성 후 기존 편집 흐름 재사용).
- 카카오 결제 승인/취소 프로세스 자체는 변경하지 않음(주문/결제 상태 업데이트 이후 후속 훅만 추가).

## 이해관계자 및 액터
- Authenticated User (주문자)
- System (주문/결제 상태 갱신, 캡슐 생성)
- Payment Provider (결제 성공/실패 콜백 제공)

## 사용자 시나리오
1. 사용자가 상품과 옵션(열람 시점, 사진 장수, 음악/영상 추가 여부, 인원수)을 선택해 주문을 생성한다.
2. 결제에 성공하여 주문 상태가 `PAID`가 되면, 시스템이 해당 주문으로 타임캡슐을 즉시 생성한다.
3. 클라이언트는 결제 승인 응답 혹은 후속 조회에서 캡슐 ID를 받아 캡슐 작성/미디어 업로드 플로우로 진입한다.
4. 캡슐은 주문 시 선택한 인원수·열람 시점·미디어 제약을 충족하도록 초기화되고, 이후 편집/열람 시에도 동일 제약을 유지한다.

## 기능 요구사항 (테스트 가능)
1. **생성 트리거**: 주문 상태가 `PAID`로 전환될 때만 캡슐 생성 시도를 한다. `PENDING/PENDING_PAYMENT/FAILED/CANCELED` 상태는 생성하지 않는다.
2. **단일 생성 보장**: 주문당 캡슐은 최대 1개만 생성된다. 동일 주문으로 재시도 시 기존 캡슐을 반환하고 추가 생성하지 않는다.
3. **소유권 검증**: 주문의 `userId`와 캡슐의 `userId`는 동일해야 한다. 불일치 시 생성하지 않고 오류를 기록한다.
4. **상품 검증**: 주문이 참조하는 상품이 활성(`is_active=true`)이며 캡슐용 상품 유형(`product_type=TIME_CAPSULE`)이어야 한다. 비활성/타입 불일치 시 캡슐을 생성하지 않고 404/422 등 도메인 오류를 반환한다.
5. **미디어 제약 적용**: 상품의 `media_types`/`max_media_count` 제약을 캡슐 생성 시 메타(허용 타입, 최대 업로드 수)로 저장하거나 이후 업로드 검증 경로가 이를 참조하도록 연결한다. 제약을 초과하는 옵션(예: photo_count > max_media_count)인 경우 생성 시 거부한다.
6. **인원수 적용**: 주문의 `headcount`를 캡슐 `viewLimit`으로 반영한다(0이면 무제한, 기본은 주문 값). 주문 headcount가 스키마 제약(1~10)을 벗어나면 생성 거부.
7. **열람 시점 계산**: 주문의 `timeOption`/`customOpenAt`에 따라 캡슐 `openAt`을 설정한다. 커스텀 값이 없는데 `CUSTOM`이면 오류로 처리한다.
8. **기본 필드 초기화**: 캡슐 생성 시 필수 필드를 채운다.
   - `userId`=주문자, `productId`=주문 상품
   - `title` 기본값(예: "나의 타임캡슐")으로 세팅, `content`/`mediaUrls`/`mediaItemIds`/`mediaTypes`/`textBlocks`는 null 또는 빈값
   - `isLocked`=true, `viewCount`=0
9. **응답/조회**: 결제 승인 API 혹은 후속 조회 API는 생성된 `capsuleId`를 반환한다. 주문 상세 조회 시에도 연계된 캡슐 ID를 확인할 수 있어야 한다.
10. **감사 로깅**: 캡슐 생성 성공/실패 사유(주문 ID, 사용자, 상품, 상태, 검증 실패 이유)를 로그로 남긴다.

## API/동작 초안
- **Hook 지점**: 결제 승인 처리(`/payments/approve` 등)에서 주문 상태를 `PAID`로 변경한 직후 캡슐 생성 유즈케이스를 호출한다.
- **Order ↔ Capsule 연계 저장 방식**:
  - 주문에 `capsule_id` 필드를 추가하거나, 캡슐에 `order_id` 필드를 추가해 양방향 추적이 가능하도록 한다(중복 생성 방지 및 조회용).
- **응답 예시**:
  - 200 (결제 승인 완료): `{ orderId, status: "PAID", capsuleId }`
  - 오류: 404(상품 비활성/타입 불일치), 409(이미 캡슐 생성됨), 422(옵션/인원/커스텀 시각 불일치)

## 데이터 모델 참고
- `orders`: `headcount`, `photo_count`, `add_music`, `add_video`, `time_option`, `custom_open_at`, `status`, `product_id`, `user_id`.
- `products`: `product_type`, `is_active`, `max_media_count`, `media_types`.
- `capsules`: `open_at`, `view_limit/view_count`, `is_locked`, `product_id`, `user_id`, `media_types`, `media_urls`, `title`, `content`.
- 필요 시 `orders` 또는 `capsules`에 연계 키(`capsule_id` 또는 `order_id`)를 추가한다.

## 성공 기준
- 결제 성공 후 동일 주문으로 중복 생성 없이 캡슐이 1개 생성되고 ID가 응답/조회에서 확인된다.
- 생성된 캡슐의 `openAt`, `viewLimit`, 미디어 제약이 주문 옵션·상품 제약과 일치하며, 제약 위반 시 생성이 거부된다.
- 비활성/타입 불일치 상품이나 미지불 주문으로는 캡슐이 생성되지 않고 적절한 오류 코드가 반환된다.
- 생성/거부 이벤트가 모두 로깅되어 운영자가 장애 시 원인을 추적할 수 있다.

