# Feature Specification: Capsule Entry & Fetch API

**Feature Branch**: `[010-capsule-entry]`  
**Created**: 2025-12-26  
**Status**: Draft  
**Input**: User description: "타임캡슐 불러오기, 타임캡슐 글 생성, 결제 완료 상품 기준으로 캡슐 데이터를 불러오고 작성자 정보를 포함, 인원수별 객체 폼으로 리스트 제공 및 저장"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 결제 완료 사용자의 타임캡슐 조회 (Priority: P1)

사용자는 결제 완료된 상품으로 생성된 타임캡슐을 열어 캡슐 메타데이터, 참여 인원 슬롯, 각 슬롯의 작성자/작성 상태, 작성된 글을 확인한다.

**Why this priority**: 결제 완료 후 제공되는 핵심 가치(캡슐 확인)가 가장 먼저 필요하다.

**Independent Test**: 결제 완료된 주문에 연결된 캡슐 ID로 GET 요청 시 캡슐 메타데이터와 참여 슬롯 리스트가 반환되고, 이미 작성된 글은 작성자 정보와 함께 표시되는지 확인.

**Acceptance Scenarios**:

1. **Given** 결제 상태가 `PAID`인 주문과 연결된 캡슐이 있고, **When** 주문 소유자가 캡슐 조회 API를 호출하면, **Then** 캡슐 기본 정보와 참여 인원수만큼의 슬롯 리스트, 각 슬롯의 작성자/작성 여부/작성 시각/글 데이터가 반환된다.
2. **Given** 캡슐에 일부 슬롯만 글이 작성된 상태에서, **When** 조회 시 **Then** 작성된 슬롯은 작성자/컨텐츠가 노출되고 미작성 슬롯은 비어 있는 상태로 반환된다.
3. **Given** 결제가 완료되지 않은 주문의 캡슐에 대해, **When** 조회 API를 호출하면 **Then** 403이 반환된다.

---

### User Story 2 - 참여자의 타임캡슐 글 작성 (Priority: P1)

캡슐 접근 권한이 있는 사용자가 자신의 슬롯에 단 한 번 글을 작성하고 저장한다.

**Why this priority**: 캡슐의 주요 액션(글 작성)이 제공되어야 기능이 완성된다.

**Independent Test**: 동일 캡슐/사용자에 대해 POST로 글 작성 후 201 반환, 재작성 시 409 또는 400으로 차단됨을 확인.

**Acceptance Scenarios**:

1. **Given** 결제 완료된 캡슐과 참여 권한이 있는 사용자, **When** 사용자가 본인 슬롯에 글을 최초 작성하여 제출하면, **Then** 글이 저장되고 슬롯 상태가 작성 완료로 업데이트된다.
2. **Given** 사용자가 동일 캡슐에 이미 글을 작성한 상태, **When** 다시 글 작성 API를 호출하면, **Then** 409(또는 400)로 거절된다.
3. **Given** 사용자에게 캡슐 접근 권한이 없을 때, **When** 글 작성 API를 호출하면, **Then** 403이 반환된다.

---

### User Story 3 - 참여 슬롯/작성자 정보 확인 (Priority: P2)

주문 소유자는 인원수별 슬롯을 확인하고, 어떤 사용자가 어떤 슬롯에 글을 작성했는지 관리한다.

**Why this priority**: 캡슐 관리/모니터링을 통해 사용자 경험과 운영 편의성을 높인다.

**Independent Test**: 캡슐 조회 시 슬롯별 사용자 매핑, 작성 여부, 작성 시각이 모두 반환되는지 확인.

**Acceptance Scenarios**:

1. **Given** 캡슐에 참여자 목록이 설정된 상태, **When** 조회 시 **Then** 각 슬롯에 사용자 ID/닉네임, 작성 여부, 작성 시각이 포함되어 반환된다.
2. **Given** 슬롯에 아직 사용자가 할당되지 않은 경우, **When** 조회 시 **Then** 빈 슬롯으로 표기되어 추가 할당이 가능함을 알 수 있다.

---

### Edge Cases

- 결제 상태가 `PAID`가 아닌 경우 접근 차단.
- 주문 소유자/참여자가 아닌 사용자의 접근 차단.
- 동일 사용자의 중복 작성 요청(재시도/동시성) 처리.
- 존재하지 않는 캡슐 ID 요청.
- 참여 인원수보다 많은 슬롯 작성 시도 또는 슬롯 미할당 상태에서의 작성 시도.

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 시스템은 결제 상태가 `PAID`인 주문에 연결된 캡슐만 조회/작성 요청을 허용해야 한다.
- **FR-002**: 시스템은 `GET /api/capsules/:capsuleId` 요청 시 캡슐 메타데이터(제목/설명/생성일/공개일 등)와 참여 인원수만큼의 슬롯 리스트를 반환해야 한다.
- **FR-003**: 슬롯 리스트는 각 슬롯의 사용자 ID/닉네임(할당된 경우), 작성 여부, 작성 시각, 작성된 글 내용(텍스트/미디어 식별자)을 포함해야 한다.
- **FR-004**: 시스템은 캡슐 접근 권한(주문 소유자 혹은 참여자) 검증 후, 권한 없으면 403을 반환해야 한다.
- **FR-005**: 시스템은 `POST /api/capsules/:capsuleId/entries` 요청으로 사용자가 자신의 슬롯에 글을 한 번만 작성하도록 보장해야 한다(중복 요청 시 409/400).
- **FR-006**: 시스템은 글 작성 시 캡슐 ID, 사용자 ID, 내용, 첨부(선택), 작성 시각을 저장하고, 슬롯 상태를 작성 완료로 갱신해야 한다.
- **FR-007**: 시스템은 존재하지 않는 캡슐 ID 요청 시 404를 반환해야 한다.
- **FR-008**: 시스템은 캡슐 조회 시 작성 이력을 감사 목적으로 로그(`capsule_access_logs`)에 기록해야 한다.
- **FR-009**: 시스템은 참여 인원수(상품 속성)와 슬롯 개수가 일치하지 않을 경우, [NEEDS CLARIFICATION: 슬롯 개수 정합성 오류 처리 정책 미정 - 자동 생성 vs 에러 반환].
- **FR-010**: 시스템은 주문 소유자가 참여자 슬롯을 사전 할당하지 않은 경우, [NEEDS CLARIFICATION: 사용자-슬롯 매핑 수집 방식(초대/링크/수동 입력) 미정].
- **FR-011**: 시스템은 작성 본문 허용 크기/포맷을 검증해야 한다. [NEEDS CLARIFICATION: 허용 길이 및 미디어 타입 제한 미정]
- **FR-012**: 시스템은 사용자가 **본인이 처음 글을 작성한 해당 캡슐의 자신의 슬롯(리스트 ID)에서만** 텍스트/음악/사진/영상 데이터를 저장할 수 있도록 제한하고, 다른 사용자의 슬롯/글에는 저장하거나 수정할 수 없도록 해야 한다(403/409 반환).
- **FR-013**: 미디어 업로드 제약(S3 presign 기준)을 준수해야 한다:  
  - 이미지: content-type `image/jpeg|image/png|image/webp`, 최대 5MB  
  - 영상: content-type `video/mp4`, 최대 200MB  
  - 음악/오디오: content-type `audio/mpeg|audio/mp4|audio/x-m4a|audio/aac`, 최대 20MB  
  - 위 제한을 초과하거나 다른 content-type인 경우 400/`INVALID_CONTENT_TYPE`/`*_SIZE_EXCEEDED`로 거절한다.

### Key Entities *(include if feature involves data)*

- **Capsule**: 결제 완료된 주문에 연결된 타임캡슐. 참여 인원수, 공개/오픈일, 제목/설명 등 메타데이터를 가진다.
- **CapsuleEntry**: 특정 캡슐에서 사용자가 작성한 글. 사용자 ID, 내용, 첨부(선택), 작성 시각, 슬롯 식별자를 포함한다.
- **CapsuleParticipantSlot**: 캡슐 당 참여 인원수만큼 존재하는 슬롯. 사용자 할당 여부, 작성 상태/시각, 연결된 CapsuleEntry를 보유한다.
- **Order/Payment**: 결제 상태(`PAID`)가 캡슐 접근 및 작성 허용 여부를 결정한다.
- **User**: 작성자/캡슐 소유자 식별 및 프로필 정보 제공.
- **CapsuleAccessLog**: 캡슐 조회/작성 이벤트 기록을 위한 감사 로그.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: `GET /api/capsules/:capsuleId` 요청에 대해 95퍼센트타일 응답 시간이 500ms 이하 (정상/권한 보유 기준).
- **SC-002**: 결제 상태가 `PAID`가 아닌 요청에서 100% 403 혹은 404를 반환(권한 없는 정보 노출 없음).
- **SC-003**: 동일 사용자 중복 작성 요청 시 100% 재작성 방지(409/400) 및 데이터 일관성 유지.
- **SC-004**: 슬롯 수(상품 인원수)와 반환되는 슬롯 리스트가 100% 일치.
- **SC-005**: 캡슐 조회/작성 이벤트가 100% `capsule_access_logs`에 기록.

